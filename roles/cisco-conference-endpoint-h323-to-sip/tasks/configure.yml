---
- assert:
    that: parsed_conf_endpoint_config is defined
    msg: >
      conf_endpoint_config should be defined.
      It should contain the XML config of the conference endpoint
- assert:
    that: temp_directory is defined
    msg: >
      temp_directory should be defined
      it defines the temporary location to store xml files
      on the ansible server
- assert:
    that: session_id is defined
    msg: >
      session_id is required to login into the
      Cisco Conference endpoint

- assert:
    that:
      - call_control_ips is defined
      - call_control_ips is iterable
    msg: >
      call_control_ips is list of Call Control Devices (CUCM/VCS)

- assert:
    that: sipdomain_name is defined
    msg: >
      sipdomain_name is required to configure SIP URI

- set_fact:
    sip_endpoint_registered: false

- block:
    - fail:
        msg: "DEBUG"

    - name: Check if Endpoint is SIP registered
      include_role:
        name: cisco-conference-endpoint-status

    - assert:
        that:
          - endpoint_status_var.sip[0].status != None

    - set_fact:
        sip_configured: true

    - set_fact:
          configure_sip: false

    - debug:
        msg:  "Endpoint has SIP Configured"

    - set_fact:
        sip_endpoint_registered: "Endpoint is SIP Registered"
      when: endpoint_status_var.sip[0].status == 'Registered'

  rescue:
    - set_fact:
        configure_sip: true


- block:
    - name: convert H323 to SIP
      include_tasks: change-to-sip.yml
    - include_tasks: verify-sip-config.yml
    - set_fact:
        sip_configured: true
  rescue:
    - set_fact:
        sip_conversion_failed: false
    - include_tasks: switch-back-to-h323.yml
  when: configure_sip == true
